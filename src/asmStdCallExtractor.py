import glob
import os
import subprocess
import sys

import paths

print '[Grepper for __stdcall]'

if sys.argv[1]=='train':
    inputPath = paths.trainDirectory
else:
    inputPath = paths.testDirectory

outputPath = paths.featuresDirectory + 'stdcall_grepper/'
if not os.path.exists(outputPath):
    os.makedirs(outputPath)
    

def worker(fileName):
    # preparation
    subprocess.call('grep "__stdcall" {}{}.asm > {}{}'.format(inputPath, fileName, outputPath, fileName), shell=True)


globFilenames = glob.glob(inputPath + '*.asm')
fnames = map(lambda x: x.split('/')[-1].split('.')[0], globFilenames)


from multiprocessing import Process
def wrapper(fileNameList):
    for fname in fileNameList:
        worker(fname)

nJobs = 15
workers = []
for workerId in range(nJobs):
    p = Process(target=wrapper, args=[[param for i, param in enumerate(fnames) if i % nJobs == workerId]])
    workers.append(p)
    p.start()
for p in workers:
    p.join()
print 'Done!'