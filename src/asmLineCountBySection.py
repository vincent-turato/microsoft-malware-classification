import cPickle
import glob
import os
import sys
from multiprocessing import Process

import paths

numJobs = paths.nJobs
print '[Section extraction script]'

if sys.argv[1]=='train':
    inputPath = paths.trainDirectory
else:
    inputPath = paths.testDirectory

outputPath = paths.featuresDirectory + 'sections_hist/'
if not os.path.exists(outputPath):
    os.makedirs(outputPath)

    
def worker(fileName):
        # preparation
        asmSectionStatistics = {}
        fin = open(inputPath + fileName + '.asm', 'r')
        for line in fin:
                curSection = line.split(':')[0].lower()
                asmSectionStatistics[curSection] = asmSectionStatistics.get(curSection, 0) + 1
                asmSectionStatistics['sum'] = asmSectionStatistics.get('sum', 0) + 1
        cPickle.dump(asmSectionStatistics, open(outputPath + fileName, 'w'))

        
globFiles = glob.glob(inputPath + '*.asm')
fileNames = map(lambda x: x.split('/')[-1].split('.')[0], globFiles)



def wrapper(fileNameList):
        for fname in fileNameList:
                worker(fname)


workers = []
for workerId in range(numJobs):
        p = Process(target=wrapper, args=[[param for i, param in enumerate(fileNames) if i % numJobs == workerId]])
        workers.append(p)
        p.start()
for p in workers:
        p.join()
print 'Done!'
