import glob
import os
import subprocess
import sys

import paths

if sys.argv[1]=='train':
    inputDir = paths.trainDirectory
else:
    inputDir = paths.testDirectory

outputPath = paths.featuresDirectory + 'instruction_frequency/'
if not os.path.exists(outputPath):
    os.makedirs(outputPath)


def worker(fileName):
        # preparation
        subprocess.call('echo "{}" >> {}{}'.format(fileName, outputPath, 'fnames'), shell=True)
        subprocess.call('cat {}{}.asm | wc -l >> {}{}'.format(inputDir, fileName, outputPath, 'line_count'), shell=True)

        assemblyInstructions = ['jmp', 'mov', 'retf', 'push', 'pop', 'xor', 'retn', 'nop', 'sub', 'inc', 'dec', 'add',
                'imul', 'xchg', 'or', 'shr', 'cmp', 'call', 'shl', 'ror', 'or', 'rol', 'jnb']
        for instruction in assemblyInstructions:
                subprocess.call('grep "\s{}\s" {}{}.asm | wc -l >> {}{}'.format(instruction, inputDir, fileName, outputPath, instruction), shell=True)



globFiles = glob.glob(inputDir + '*.asm')
fileNames = map(lambda x: x.split('/')[-1].split('.')[0], globFiles)
for i, fileName in enumerate(fileNames):
        worker(fileName)
        if i % 200 == 0:
                print i
print 'Done!'