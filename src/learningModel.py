import sys
import numpy as np
import pandas as pd
from pylab import *
from sklearn.externals import joblib

import paths

sys.path.append('../git/xgboost/wrapper/')
import xgboost as xgb

print "Running model. This may take several minutes."

Xtrain, Xtest = joblib.load(paths.featuresDirectory + 'X_basepack')
ytrain = np.array(pd.read_csv(paths.trainLabels)['Class']) - 1

xgbParameters = {}
xgbParameters['booster'] = 'gbtree'
xgbParameters['objective'] = 'multi:softprob'
xgbParameters['num_class'] = 9
xgbParameters['eval_metric'] = 'logloss'
xgbParameters['scale_pos_weight'] = 1.0
xgbParameters['bst:eta'] = 0.3
xgbParameters['bst:max_depth'] = 6
xgbParameters['bst:colsample_bytree'] = 0.5
xgbParameters['silent'] = 1
xgbParameters['nthread'] = 16

numRounds = 100
xgbParametersList = list(xgbParameters.items())
watchlist = []

time0 = time.time()
indtrain = arange(len(ytrain))
yfinalxg = np.zeros((len(Xtest), 9))

bgs = 20
import random
for bg in range(bgs):
    xgbParameters['seed'] = bg + 1
    xgbParametersList = list(xgbParameters.items())

    newindtrain = random.sample(indtrain, int(len(indtrain) * 1.0))

    for i in range(int(len(indtrain) * 7.0)):
        newindtrain.append(random.choice(indtrain))
        
    xDataTrain = xgb.DMatrix(data = Xtrain[newindtrain], label = ytrain[newindtrain])
    xDataTest = xgb.DMatrix(data = Xtest)

    bst = xgb.train(xgbParametersList, xDataTrain, numRounds, watchlist)

    currentPrediction = bst.predict(xDataTest).reshape((len(Xtest), 9))
    yfinalxg += currentPrediction

    print bg, (time.time() - time0) / 60.

yfinalxg /= bgs


dfinal = pd.read_csv(paths.sampleSubmissionFile)

dfinal.ix[:, 1:] = yfinalxg
dfinal.to_csv(paths.submissionDirectory + 'submission.csv', index = False)

print "Success. Submission saved in: " + paths.submissionDirectory
